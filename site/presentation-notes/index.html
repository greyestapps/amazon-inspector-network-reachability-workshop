
<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
        <meta name="description" content="The workshop will demonstrate how you can validate their network configuration without needing to have a deep networking background by using Inspectors Network Reachability report. You will learn how this report can help them find misconfigurations in the architecture or behaviors they might not have expected. The demo will finish with using the Network Reachability report findings integrated with other Security Services to remediate these issues.">
      
      
        <meta name="author" content="aws-security-workshops@amazon.com">
      
      
        <link rel="canonical" href="https://github.com/aws-samples/amazon-inspector-network-reachability-workshop/presentation-notes/">
      
      
        <link rel="prev" href="../05-cleanup/">
      
      
        <link rel="next" href="../contribute/">
      
      <link rel="icon" href="../images/aws-favicon.ico">
      <meta name="generator" content="mkdocs-1.4.2, mkdocs-material-9.1.2">
    
    
      
        <title>Presentation Notes - Finding and addressing Network Misconfigurations on AWS</title>
      
    
    
      <link rel="stylesheet" href="../assets/stylesheets/main.7bf56d0a.min.css">
      
        
        <link rel="stylesheet" href="../assets/stylesheets/palette.a0c5b2b5.min.css">
      
      

    
    
    
      
        
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&display=fallback">
        <style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style>
      
    
    
      <link rel="stylesheet" href="../stylesheets/custom.css">
    
    <script>__md_scope=new URL("..",location),__md_hash=e=>[...e].reduce((e,_)=>(e<<5)-e+_.charCodeAt(0),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
    
      

    
    
    
  </head>
  
  
    
    
    
    
    
    <body dir="ltr" data-md-color-scheme="default" data-md-color-primary="" data-md-color-accent="">
  
    
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#optional-presentation-notes" class="md-skip">
          Skip to content
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
    
      

  

<header class="md-header md-header--shadow" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="Header">
    <a href=".." title="Finding and addressing Network Misconfigurations on AWS" class="md-header__button md-logo" aria-label="Finding and addressing Network Misconfigurations on AWS" data-md-component="logo">
      
  <img src="../images/aws_smile_logo.png" alt="logo">

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3V6m0 5h18v2H3v-2m0 5h18v2H3v-2Z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            Finding and addressing Network Misconfigurations on AWS
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              Presentation Notes
            
          </span>
        </div>
      </div>
    </div>
    
    
    
      <label class="md-header__button md-icon" for="__search">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5Z"/></svg>
      </label>
      <div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="Search" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" required>
      <label class="md-search__icon md-icon" for="__search">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5Z"/></svg>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12Z"/></svg>
      </label>
      <nav class="md-search__options" aria-label="Search">
        
        <button type="reset" class="md-search__icon md-icon" title="Clear" aria-label="Clear" tabindex="-1">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12 19 6.41Z"/></svg>
        </button>
      </nav>
      
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            Initializing search
          </div>
          <ol class="md-search-result__list" role="presentation"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
    
    
      <div class="md-header__source">
        <a href="https://github.com/aws-samples/amazon-inspector-network-reachability-workshop" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 6.3.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2023 Fonticons, Inc.--><path d="M439.55 236.05 244 40.45a28.87 28.87 0 0 0-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 0 1-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 0 0 0 40.81l195.61 195.6a28.86 28.86 0 0 0 40.8 0l194.69-194.69a28.86 28.86 0 0 0 0-40.81z"/></svg>
  </div>
  <div class="md-source__repository">
    amazon-inspector-network-reachability-workshop
  </div>
</a>
      </div>
    
  </nav>
  
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
          
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    


<nav class="md-nav md-nav--primary" aria-label="Navigation" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href=".." title="Finding and addressing Network Misconfigurations on AWS" class="md-nav__button md-logo" aria-label="Finding and addressing Network Misconfigurations on AWS" data-md-component="logo">
      
  <img src="../images/aws_smile_logo.png" alt="logo">

    </a>
    Finding and addressing Network Misconfigurations on AWS
  </label>
  
    <div class="md-nav__source">
      <a href="https://github.com/aws-samples/amazon-inspector-network-reachability-workshop" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 6.3.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2023 Fonticons, Inc.--><path d="M439.55 236.05 244 40.45a28.87 28.87 0 0 0-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 0 1-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 0 0 0 40.81l195.61 195.6a28.86 28.86 0 0 0 40.8 0l194.69-194.69a28.86 28.86 0 0 0 0-40.81z"/></svg>
  </div>
  <div class="md-source__repository">
    amazon-inspector-network-reachability-workshop
  </div>
</a>
    </div>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href=".." class="md-nav__link">
        Overview
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../01-environment-setup/" class="md-nav__link">
        Module 1: Environment Build and Configuration
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../02-running-inspector/" class="md-nav__link">
        Module 2: Running the Inspector Report
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../03-evaluate-findings/" class="md-nav__link">
        Module 3: Evaluating Findings
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../04-integration-and-remediation/" class="md-nav__link">
        Module 4: Integration and Remediation
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../05-cleanup/" class="md-nav__link">
        Module 5: Cleanup
      </a>
    </li>
  

    
      
      
      

  
  
    
  
  
    <li class="md-nav__item md-nav__item--active">
      
      <input class="md-nav__toggle md-toggle" type="checkbox" id="__toc">
      
      
        
      
      
      <a href="./" class="md-nav__link md-nav__link--active">
        Presentation Notes
      </a>
      
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../contribute/" class="md-nav__link">
        Contributing
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../license/" class="md-nav__link">
        License
      </a>
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              
              <div class="md-sidebar md-sidebar--secondary" data-md-component="sidebar" data-md-type="toc" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
</nav>
                  </div>
                </div>
              </div>
            
          
          
            <div class="md-content" data-md-component="content">
              <article class="md-content__inner md-typeset">
                
                  

  
  


<h1 id="optional-presentation-notes">Optional: Presentation Notes</h1>
<p>While the environment is building let’s talk about what this represents. Remember, this scenario is comprised of a new company that has been in AWS for a few months and are moving their first few workloads in the cloud. The CloudFormation template is modeling their environment. The first workload to move was an external website with a database back end. Security insisted that access to those servers only be through a set of bastion hosts in a separate VPC. Recently, a developer has created a public proof of concept for a new highly available web service and connected it to the environment without going through all the proper change management. The developer did the right thing by putting two different servers in two different availability zones. But since the two AZs have different Security Groups, each with different port filtering setup, the workload may not be able to successfully failover correctly. The various IT stakeholders have been working off some assumptions but have not had the chance to test them yet.</p>
<p>Assumption 1.> Instances in private subnets are not accessible from the internet</p>
<p>Assumption 2.> Putting servers in different Availability zones provide failover and better reliability</p>
<p>Assumption 3.> Nothing can route through the bastion VPC.</p>
<p>Assumption 4.> Access to the servers is limited by least privilege</p>
<p>Assumption 5.> The bastion hosts can access all environments</p>
<p>The IT team found the developer’s new environment not because of controls, but because the bill came back above budget. Now the security and operations team want to validate the right security is applied to the new environment as well as the existing one. They will use the Network Reachability report in Amazon Inspector to provide them validation of their network assumptions. This is a recent addition to Inspector, going public in November of 2018. </p>
<p>Let’s look at their architecture on Slide 2.</p>
<p>Example Corp. has isolated workloads by VPC and has used VPC peering to meet some connectivity assumptions. You can see they tried to build public and private subnets, but we have to dig deeper to see what’s actually going on there. Their production web app on the left has a load balancer in front of it, which is great. But you can see the PoC environment is not as mature.</p>
<p>Before we dive too deep though, let’s go back and see what the built environment looks like.</p>
<p><a href="../02-running-inspector/">Running the Inspector Report</a></p>
<h1 id="module-2-architecture-review"><a name="mod2"></a>Module 2 - Architecture Review</h1>
<p>Let’s go back to the architecture we looked at earlier. We know we need more information to better understand the data flows and connectivity. So let’s dig deeper to see if they designed everything right.</p>
<p>Let’s look at the route tables they’ve built. Slide 3 contains all of the information regarding routes in their environment.</p>
<p>Right away we see that something named “Public Route” applies to the Database subnets. What else can we glean from these? For example, what IP address range is their corporate office?</p>
<p>Okay, let’s look at the Security Groups on Slide 4.</p>
<p>So here we see some good things and some troubling things as well. The Load Balancer and Web Server look like they’ve been configured well. They both use Security Group references instead of CIDR blocks to allow access. But the database server Security group is in trouble. Rather than using the Web Server Security Group it looks like it’s set to everyone. The route table misconfiguration we saw earlier can mean this is a real problem.</p>
<p>What about the Bastion Server security group and CIDR blocks. Is there a better way to handle those? For example, is there a better way than IP addresses to reference groups of servers in AWS?</p>
<p>There are more Security Groups on Slide 5. The PoC environment specifically. What do you see wrong here? </p>
<p>Let’s go back to the assumptions we talked about earlier. Slide 6 has a refresher. We can walk through each of these individually in the following slides.</p>
<ol>
<li>
<p><em>Let’s talk about Assumption 1 the Security Team put in place. Assuming a properly architected three-tier web application, do the Web or DB Subnets need to be open to the internet for the website to work?</em></p>
<ul>
<li>No. The only group that needs to be public is the Security Group for the Load Balancers.</li>
</ul>
</li>
<li>
<p><em>What does a properly secured solution look like from a data flow perspective? What subnets or instances need to be public?</em></p>
<ul>
<li>The Load Balancer in the public subnet needs to be public. But the webserver can have port 80 locked down to only be accessible from the Load Balancers. The Web server security group can enforce this. The Database subnet and servers can also be locked down to just the Web servers by using Security Group associations. To meet the security requirement, SSH and RDP can also be locked down to the Bastion servers.</li>
</ul>
</li>
<li>
<p><em>Can the Bastion servers be referenced by Security Group, or just IP address range?</em></p>
<ul>
<li>Security groups can be shared across VPC Peers when the proper approvals are put in place.</li>
</ul>
</li>
<li>
<p><em>What about the Bastion hosts? How do we use Ingress and Egress Security Group rules in Security Groups to control their access?</em></p>
<ul>
<li>Only requests coming from on-premises should be able to SSH or RDP into the Bastion servers. This is limited by Ingress rules. The Bastion hosts can then only talk to the servers it has been approved to talk to. This is controlled by Egress Rules.</li>
</ul>
</li>
<li>
<p><em>What about Assumption 2? What should we look at to validate if this is true and does this diagram look right?</em></p>
<ul>
<li>We would want to look at Routing Tables and NACL’s for subnets, Security Groups for Instances, and NAT and Internet Gateways in VPC’s. In this case, the WebApp VPC looks both good and bad. The Security Groups are shared and the routing tables are the same between the subnets in different AZ’s. The single NAT Gateway is not ideal but does minimize the number of route tables necessary reducing the risk of a misconfiguration. The Bastion VPC looks setup correctly. The route tables and security groups look right. For the Proof of Concept VPC though there’s a lot wrong. There’s no need to split the security group and in doing so many of the rules are incorrect. This means that the Availability Zone failover won’t work right.</li>
</ul>
</li>
<li>
<p><em>But if the WebApp VPC and Proof of Concept VPC are both connected to the Bastion VPC, can’t they talk to each other too? (Assumption 3)</em></p>
<ul>
<li>No. AWS VPC’s are not transitive in nature. Routing is basically a single hop only for VPC Peering. Now that can be changed with Transit VPC’s, 3rd party tools, or instances acting like routers, but in general VPC Peering does not have transitive properties. The Network Reachability report will show us this.</li>
</ul>
</li>
<li>
<p><em>So we’ve talked about the routing to each subnet and server, but what about the Security Groups. For Assumption 4 what are the best ways to accomplish and validate least privilege? How can we use automated checks to validate this instead of doing it manually?</em> </p>
<ul>
<li>
<p>To accomplish least privilege each Security Group should map to other Security Groups. For example: The Web Servers should have an ingress rule only allowing traffic from the Load Balancers on Port 80, and the Database Servers should only have an ingress rule from the Web Servers from port 3306. Even across VPC Peers it’s possible to use Security Groups to only allow traffic from the Bastion Hosts to instances in the WebApp VPC if peering allows for it.</p>
<p>But to validate this manually is time consuming and error prone, especially in large environments. So instead, using things like the Inspector Reachability Report we can validate certain assumptions. For example, making sure that only Web Servers can talk to Database servers. So even in non-ideal scenarios, where IP blocks are used to allow access, we can check to make sure instances aren’t accessible from the internet. Or if they are, that Security Groups block their access. This is Defense in Depth.</p>
</li>
</ul>
</li>
<li>
<p><em>Given that sometimes changes happen without people’s knowledge, how can we confirm what’s accessible? For example, when the developer built the Proof of Concept space, they built a peer relationship and routed to the Bastion hosts. Can they connect?</em></p>
<ul>
<li>No. The developer did a good job of building connectivity to the Bastion VPC, but the Bastion VPC does not have the proper routing or Security Group rules to allow access to the PoCVPC. Both would need to be added to provide connectivity. The Network Reachability report shows this too.</li>
</ul>
</li>
</ol>
<p>So then let’s go to <a href="../03-evaluate-findings/">Evaluating Findings</a> to look at how the report helps us validate these assumptions or findings.</p>
<h1 id="frequently-asked-questions"><a name="faq"></a>Frequently Asked Questions</h1>
<ol>
<li>
<p><strong>Does it replace a vulnerability scan?</strong></p>
<ol>
<li>No. This will tell you what servers can talk to what, but it doesn’t give you details of everything installed on those servers. When used in conjunction with other Inspector reports you do get closer to a full vulnerability scan, but you may want to compare to existing tools in your environment.</li>
</ol>
</li>
<li>
<p><strong>Are you sending real traffic?</strong></p>
<ol>
<li>No. The Network Reachability report uses the Zelkova framework inside of AWS to create mathematical proofs of communication channels. No actual packets are sent in the network. You can find out more at: <a href="https://aws.amazon.com/security/provable-security/">https://aws.amazon.com/security/provable-security/</a></li>
</ol>
</li>
<li>
<p><strong>Is the agent open source?</strong></p>
<ol>
<li>Not at this time.</li>
</ol>
</li>
<li>
<p><strong>What operating systems support the Amazon Inspector Agent?</strong></p>
<ol>
<li>Certain Amazon provided AMI’s come with the Inspector agent already installed, and those will be notes in the title with “<strong>with Amazon Inspector Agent</strong>”. You can find the complete list of supported operating systems in the AWS documentation at: <a href="https://docs.aws.amazon.com/inspector/latest/userguide/inspector_supported_os_regions.html">https://docs.aws.amazon.com/inspector/latest/userguide/inspector_supported_os_regions.html</a></li>
</ol>
</li>
<li>
<p><strong>Is the agent running as root?</strong></p>
<ol>
<li>When installed following the AWS documentation, yes. More information can be found here: <a href="https://docs.aws.amazon.com/inspector/latest/userguide/inspector_agents.html">https://docs.aws.amazon.com/inspector/latest/userguide/inspector_agents.html</a>.</li>
</ol>
</li>
<li>
<p><strong>Does the agent need a TCP/UDP port to be open?</strong></p>
<ol>
<li>Yes. Outbound 443 to the Inspector and S3 (for logging) service endpoints is required. Please see the documentation at <a href="https://docs.aws.amazon.com/inspector/latest/userguide/inspector_agents.html">https://docs.aws.amazon.com/inspector/latest/userguide/inspector_agents.html</a> for more details.</li>
</ol>
</li>
</ol>





                
              </article>
            </div>
          
          
        </div>
        
      </main>
      
        <footer class="md-footer">
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-copyright">
  
    <div class="md-copyright__highlight">
      <a href="https://aws.amazon.com/privacy/" target="_blank">Privacy</a> | <a href="https://aws.amazon.com/terms/" target="_blank">Site terms</a> | &copy; 2023, Amazon Web Services, Inc. or its affiliates. All rights reserved.
    </div>
  
  
    Made with
    <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
      Material for MkDocs
    </a>
  
</div>
      
    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    
    <script id="__config" type="application/json">{"base": "..", "features": [], "search": "../assets/javascripts/workers/search.208ed371.min.js", "translations": {"clipboard.copied": "Copied to clipboard", "clipboard.copy": "Copy to clipboard", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.placeholder": "Type to start searching", "search.result.term.missing": "Missing", "select.version": "Select version"}}</script>
    
    
      <script src="../assets/javascripts/bundle.fc8c2696.min.js"></script>
      
    
  </body>
</html>