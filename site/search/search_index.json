{"config":{"lang":["en"],"separator":"[\\s\\-]+","pipeline":["stopWordFilter"]},"docs":[{"location":"","title":"Overview","text":"<p>In this workshop you will learn how to use the Amazon Inspector Network Reachability report to validate your network configuration without needing a deep background in networking. You will use this report to find misconfigurations that may result in unintended behaviors and unexpected vulnerabilities. You will finish the workshop by remediating these vulnerabilities by integrating the findings of Amazon Inspector with other AWS services.</p> <ul> <li> <p>Level: Intermediate</p> </li> <li> <p>Duration: 1:30 - 2:00 hours</p> </li> <li> <p>CSF Functions: Detect, Respond</p> </li> <li> <p>CAF Components: Detective, Responsive</p> </li> </ul>"},{"location":"#prerequisites","title":"Prerequisites","text":"<ol> <li>You will need an AWS account for this workshop and administrative credentials.</li> <li>You should be familiar with AWS core services such as Amazon EC2, Amazon VPC, and AWS CloudFormation. You should also be comfortable using the AWS console.</li> <li>Run this workshop in the eu-west-1 region.</li> <li>You must have an EC2 key pair in the region eu-west-1. Create one in the AWS management console and download it to your computer.</li> </ol>"},{"location":"#workshop-scenario","title":"Workshop Scenario","text":"<p>Example Corp. has been in AWS for a few months and is moving its first few workloads into AWS. The first workload to move was an external website with a database back end. Example Corp.\u2019s security team insisted administrative access to servers must be through a set of bastion hosts in a separate VPC. Recently, a developer has created a public proof of concept for a new highly available web service and connected it to the environment without going through all the proper change management. The various IT stakeholders have been working off the following untested assumptions:</p> <p>Assumption 1. Instances in private subnets are not accessible from the internet</p> <p>Assumption 2. Putting servers in different Availability zones provides both failover and better reliability</p> <p>Assumption 3. Nothing can route through the bastion VPC</p> <p>Assumption 4. Access to the servers is limited according to the principle of least privilege</p> <p>Assumption 5. The bastion hosts can access all environments</p> <p>Example Corp's IT team found the new configuration not because of controls, but from the increase in their AWS bill. As a result, the security and operations teams want to validate the right security is applied to both the new and existing environments using the Inspector Network Reachability report.</p>"},{"location":"#architecture","title":"Architecture","text":"<p>You will use AWS CloudFormation to build the environment</p> <p>The CloudFormation template will build the following elements of the workshop in a single account and will not use any existing VPCs.</p> <ul> <li>Three VPCs - VPC 1, 2, and 3.  VPC 1 and VPC 2 are both peered to VPC 3.</li> <li>VPC 1 (the Web Application VPC) spans two Availability Zones each of which contains one public subnet and two private subnets.  The VPC also includes Application Load Balancers, web servers, and database servers.</li> <li>VPC 2 (the Proof of Concept VPC) spans two Availability Zones each of which contains one public subnet and one private subnet.  The VPC also includes two servers.</li> <li>VPC 3 (the Bastion VPC) spans two Availability Zones each of which has one private subnet.  The VPC also contains two bastion servers that offer SSH and RDP access to the environment.</li> </ul> <p>This environment is shown below.</p> <p></p> <p>Here are the Route Tables and Security Groups for you to review as well.</p> <p></p> <p></p> <p></p>"},{"location":"#region","title":"Region","text":"<p>Please use the eu-west-1 region.</p>"},{"location":"#modules","title":"Modules","text":"<p>The workshop is broken up into the five modules below:</p> <ol> <li>Environment Build and Configuration</li> <li>Running the Inspector Report</li> <li>Evaluating Findings</li> <li>Integration and Remediation</li> <li>Cleanup</li> </ol>"},{"location":"01-environment-setup/","title":"Module 1: Environment Build and Configuration","text":"<p>In this first module you will build the environment using a CloudFormation template. As a reminder, make sure you are in the eu-west-1 region. You must also have an Amazon EC2 Key Pair in the region. If you do not, you must create an EC2 Key Pair for the instances to use.</p> <p>The CloudFormation template takes about 10 minutes to deploy in total; 5 minutes to deploy the infrastructure and an additional 5 minutes for listeners to become active on the instances.</p>"},{"location":"01-environment-setup/#deploy-the-cloudformation-template","title":"Deploy the CloudFormation template","text":"<p>Running the CloudFormation script is easy. There are specific outputs at the end of the process to help you test and validate the instances are up and keep track of instances while looking at the Inspector Report.</p> <p>Before you deploy the CloudFormation template feel free to view it here. To deploy the CloudFormation template in the eu-west-1 region and complete steps 1-4 below you can click the following button.</p> <ol> <li> <p>Make sure you are signed in into your AWS account and you are in the eu-west-1 region</p> </li> <li> <p>Go to the AWS CloudFormation console by clicking the button below EU West 1 (Ireland) </p> </li> <li> <p>Check the parameters section and select the KeyPair you created before under PassedKeyName</p> </li> <li> <p>Acknowledge the CloudFormation Template creates a user by checking the box.     </p> </li> <li> <p>Click \u201cCreate Stack\u201d</p> </li> </ol> <p>CloudFormation will now build the stack.  Wait until the status changes to CREATE_COMPLETED. While CloudFormation is building the stack, feel free to review the presentation materials. After the stack build is finished, proceed to the next phase, Running the Inspector Report.</p>"},{"location":"02-running-inspector/","title":"Module 2 - Running the Inspector Report","text":"<p>In the previous module you created the workshop's environment including EC2 instances running various applications. In this module you will gather the information from the CloudFormation Stack and use it to validate those services are running and run an Inspector Network Reachability report.</p>"},{"location":"02-running-inspector/#running-the-inspector-report","title":"Running the Inspector Report","text":"<ol> <li> <p>Refresh the CloudFormation interface until the Status shows \u201cCreate Complete\u201d</p> <p></p> </li> <li> <p>Click on the Stack Name</p> </li> <li> <p>Go to the Outputs tab of the Stack</p> <p></p> </li> <li> <p>Copy the DNS names from the Output frame into a text editor window. You can use these to validate the Web servers that should be publically accessible are.</p> <ol> <li> <p>The LoadBalancerFullDNS and PoCWebServer1PublicDNS should work.</p> </li> <li> <p>PoCWebServer2PublicDNS should time out.</p> </li> </ol> </li> <li> <p>Copy the instance ID\u2019s from the Output frame into a text editor window. These will help you when you review the Inspector report.</p> </li> <li> <p>Go to the EC2 console to validate the instances are running.</p> <p></p> </li> <li> <p>Go to the Inspector console.</p> <p>Next you will create the Amazon Inspector Targets and Templates. This workshop makes you do this manually to get a feel for how it works, but this can be automated.</p> <p>First, you create the Assessment Target to include all instances, even those without the agent.</p> <p></p> <p>If you have not used Inspector in this region before</p> <p>You will get a different set of screens. Start by clicking a.) \u201cGetting Started\u201d on the Inspector page, and then b.) \u201cAdvanced Setup\u201d on the bottom right to get to the Assessment Target screen \u2013 Step 10</p> </li> <li> <p>Click on Assessment Targets. Your window should be similar to the image below.</p> <p></p> </li> <li> <p>Click \u201cCreate\u201d</p> </li> <li> <p>Fill out the screen as follows:</p> <ol> <li> <p>Name: {Whatever name you will remember}</p> </li> <li> <p>All Instances: Uncheck the box</p> </li> <li> <p>Use Tags</p> <ol> <li> <p>Key: NetworkReachabilityDemo</p> </li> <li> <p>Value: True</p> </li> </ol> </li> <li> <p>Install Agents: Uncheck the box</p> </li> </ol> <p></p> <p>Service Linked Role</p> <p>Inspector may prompt you for permission to create a Service Linked role to give the Inspector service permission to do work on your behalf.  Click OK.</p> </li> <li> <p>Click \u201cSave\u201d</p> <p>If you have not used Inspector in this region before</p> <p>You should click \"Next\" to get to the Assessment Template screen \u2013 Step 14</p> </li> <li> <p>Click on Assessment Templates</p> </li> <li> <p>Click on \u201cCreate\u201d</p> <p></p> </li> <li> <p>Fill out the screen as follows:</p> <ol> <li> <p>Name: {Whatever name you will remember}</p> </li> <li> <p>Target Name: {The Assessment Target you just created} - This is only required if you have already used Inspector in this region before. Otherwise this is enabled by default.</p> </li> <li> <p>Rules packages: Select ONLY \u201cNetwork Reachability-1.1\u201d</p> </li> <li> <p>Duration: \u201c15 minutes\u201d</p> </li> <li> <p>Assessment Schedule: Uncheck the box</p> </li> </ol> </li> <li> <p>Click the button labelled \u201cCreate\u201d or \u201cCreate and run\u201d</p> </li> <li> <p>Click on Assessment Runs and then the refresh icon. Your window should be similar to the image below.</p> <p></p> </li> <li> <p>The status should say \u201cAnalyzing\u201d or \u201cCollecting data\u201d</p> <p>You are now going to publish the report to an SNS topic so you can take action. An SNS topic has been created for you in the CloudFormation Template.</p> </li> <li> <p>Click on Assessment templates</p> </li> <li> <p>Click on the right arrow next to the Assessment your created to expand the options.</p> </li> <li> <p>Click on box under \"SNS topics\"</p> </li> <li> <p>Click the drop down and select the Topic named {Accountnumber}:InspectorAutomation</p> </li> <li> <p>Deselect all of the events EXCEPT \"Findings Reported\".</p> </li> <li> <p>Click Save</p> </li> </ol> <p>You have successfully configured Inspector and started an assessment. This assessment can take up to 15 minutes, so now\u2019s a good time for you to review the architecture. The Presentation includes the architecture diagram, the route tables, and the security groups. The Presentation Notes page then walks through the architecture with some probing questions.</p> <p>You can also choose to skip to Evaluating Findings once the report is complete.</p>"},{"location":"03-evaluate-findings/","title":"Module 3 - Evaluating Findings","text":"<p>In the previous module you started the Inspector Assessment against all of the instances and network configurations you created in Module 1. In this module you will evaluate the various findings generated by the Inspector report and identify potential mitigations. You will use these findings to evaluate the assumptions discussed in the start of the workshop. For reference they are:</p> <p>Assumption 1.&gt; Instances in private subnets are not accessible from the internet</p> <p>Assumption 2.&gt; Putting servers in different Availability zones provides both failover and better reliability</p> <p>Assumption 3.&gt; Nothing can route through the bastion VPC</p> <p>Assumption 4.&gt; Access to the servers is limited according to the principle of least privilege</p> <p>Assumption 5.&gt; The bastion hosts can access all environments</p>"},{"location":"03-evaluate-findings/#evaluating-the-inspector-report-findings","title":"Evaluating the Inspector Report Findings","text":"<p>Let's look at the Inspector Network Reachability report findings and see what you can learn.</p> <ol> <li> <p>Go back to the Inspector console and select Assessment Runs from the navigation. Your assessment should be marked \"Analysis Complete\".</p> <p></p> </li> <li> <p>Click on \u201cFindings\u201d</p> <p></p> <p>Inspector Agent delay</p> <p>If you see multiple Medium findings and none of the findings indicate the Inspector agent was running, you will need to delete the Assessment and run it again. This means the instances did not have the Inspector agent running at the time of the scan. The agent is installed, it may just have been coming active.</p> <p>To begin, you will start evaluating the higher severity findings. So let\u2019s take a look at a Medium finding first.</p> </li> <li> <p>Expand the Medium finding by clicking the arrow to the left of \u201cMedium\u201d</p> <p></p> <p>First, copy the ARN (Amazon Resource Name) that begins with \"arn:\" into a text editor window, you will need it later. You can see that a misconfigured Security Group is allowing access to an instance and the instance is listening on that port. So Assumption 4 was wrong. This is something the Security team would want addressed first.</p> <p>So since you know some things are wrong, let\u2019s check the other findings for this server. You do that by filtering by the instance ID.</p> </li> <li> <p>Highlight the AWS agent ID, copy it, and scroll back to the top to paste the Instance ID of the offending instance in the \u201cFilter\u201d</p> <p></p> <p>Hover over the finding titles with your mouse. You will immediately see multiple findings about Peered connections, one Low and the top three Informational findings. Since you already looked at the SSH finding and know you need to address that, let\u2019s look at the Informational finding for this peered connection.</p> </li> <li> <p>Expand the \u201cFinding\u201d Column so you can see enough of the title to see \u201cPeered\u201d</p> </li> <li> <p>Expand the Informational finding that starts with \u201cAggregate network exposure\u201d and has \u201cPeered\u201d</p> <p></p> </li> <li> <p>Check what VPC is peered. Click on the VPC Peering Connection link in the finding to open it in a new window. Note the peer name.</p> </li> <li> <p>Click on the VPC peer name from the finding.</p> </li> <li> <p>Click on the Requester VPC in the bottom window.</p> <p>Here you see the peer is to the Bastion VPC. This is okay because you expect this behavior. What you don\u2019t see, however, is anything about connectivity from the WebApp VPC. That\u2019s because the report knows there\u2019s no way to transit through multiple VPC Peering connections today. So this helps you validate Assumption 3 is true as long as there\u2019s no additional routing the report can\u2019t see (for example a Cisco CSR Transit VPC). But this also means Assumption 5 is false because there is no Peer between the Bastion VPC and the Proof of Concept.</p> <p>What about the multiple Availability Zone configuration though for this Proof of Concept? Given the misconfiguration, you should check Assumption 2. Since you want to check against multiple Instances, let\u2019s filter by VPC, in this case the PoCVPC.</p> </li> <li> <p>Close the preview window and go back to the findings. Scroll back to the top and put the VPC ID of the offending instance in the \u201cFilter\u201d. Collapse the first finding you had open.</p> <p></p> <p>Next, you want to compare the Internet reachability. The most relevant findings related to internet access are the \u201cAggregate network exposure\u201d findings. Those are found half way down the list. Comparing them visually you will see one instance only has port 80 open. </p> </li> <li> <p>Expand the first finding that starts with \u201cAggregate network exposure\u201d and has \u201cinternet\u201d.</p> <p></p> </li> <li> <p>Notice only port 80 is open. Collapse this finding.</p> </li> <li> <p>Expand the second finding that starts with \u201cAggregate network exposure\u201d and has \u201cinternet\u201d \u2013 it will have a different instance ID.</p> <p></p> <p>Here you see the other instance has ports 22 and 443 open.</p> <p>This would indicate than in a failover scenario the second instance would fail to respond to any HTTP traffic. So this must be fixed for failover to work. Assumption 2 is proven false.</p> <p>The remaining assumption, Assumption 1, related to the Private Subnets, so let's move on from the POC Server side. You have a couple of things you need to address so can send this report to the developer to have them fix things. Let\u2019s start looking at the WebApp side. Notice the route table for the Database subnet is incorrect, so let\u2019s see if that is having any security impact. Again you can filter by the instance ID, or something you expect to see in the finding. For example, let\u2019s filter by the port number: 3306.</p> </li> <li> <p>Collapse the open findings. Scroll back to the top and put \u201c3306\u201d in the \u201cFilter\u201d</p> <p></p> <p>Here you are looking for instances open to the internet on this port. One of the first findings indicate the instance has ports are reachable from the internet.</p> </li> <li> <p>Expand the finding that starts with \u201cAggregate network exposure\u201d and has \u201cinternet\u201d</p> <p></p> <p>From the naming context you know this is wrong since this instance shouldn't have access from the internet. But rather than following this one recommendation, you can also to apply a different route table to the subnet. This just shows how there are different ways to solve the same problem, but it requires context. This is a good example where defense in depth is important. You may have set the Security Group to 0.0.0.0/0 for testing or internal access purposes, but because of a bad assumption you potentially put your entire environment at risk.</p> <p>In the end this proves Assumption 1 was false and needs to be revisited for all servers.</p> </li> </ol> <p>Alternative methods of analysis<p>There\u2019s another way to compare instance findings like this. You can download all of these findings in a .csv file, allowing you to sort, filter, and compare much more programmatically. We choose not to do this to provide a consistent experience for all participants.</p> </p>"},{"location":"03-evaluate-findings/#take-aways","title":"Take Aways","text":"<p>Thanks to the Network Reachability report you were able to validate one assumption but prove that 80% of our assumptions had problems due to misconfigurations. The Network Reachability report gives you confidence in understanding which instances could talk to whom, and in a consistently reportable, auditable manner. This is the power of Amazon Inspector.</p> <p>But now what? You don't want to leave these issues as they are, so let's see how to automatically remediate them by combining other AWS tools and services. Integration and Remediation will do just that.</p>"},{"location":"04-integration-and-remediation/","title":"Module 4 - Integration and Remediation","text":"<p>In the previous module you identified issues with the network configuration and began remediating them. In this module you will leverage additional AWS services to deploy automatic remediations to known bad configurations. </p>"},{"location":"04-integration-and-remediation/#integrating-inspector-with-other-aws-security-services","title":"Integrating Inspector with other AWS Security Services","text":"<p>In the previous module you configured your assessment to send findings to a Simple Notification Service topic. Now you are going to use that to trigger a Lambda function to remediate common findings. The CloudFormation template has deployed a Lambda function to block SSH access to misconfigured instances and included it in the CloudFormation template. Let's build the connection from SNS to Lambda and review the code.</p> <ol> <li> <p>Go to the Amazon Simple Notification Service console</p> </li> <li> <p>Click on Topics on the left hand side</p> <p></p> </li> <li> <p>Click on the Topic named \"InspectorAutomation\"</p> <p>In order to have the SNS topic send data to Lambda, you need to create a subscription. You should see the subscriptions window on the bottom and it should be empty.</p> </li> <li> <p>Click Create Subscription</p> <p></p> </li> <li> <p>The Topic ARN should be filled out, but if it's not click on it and select the topic.</p> </li> <li> <p>Click on the Protocol drop down and select AWS Lambda</p> </li> <li> <p>You should now see another dropdown. Click on it and select the one Lambda function that's there.</p> <p></p> </li> <li> <p>Click Create Subscription</p> <p>We've now configured SNS to send any alerts it receives to our Lambda function. Our Lambda function is configured to only respond to specific findings in specific ways. If you're interested in reviewing the Lambda function you can go to the Lambda console. The relevant piece of code for this activity are shown below:</p> <p></p> <p>You can see here that the Lambda code adds a Network ACL line that blocks SSH from the internet to any instance that has SSH open to the internet.</p> <p>To trigger this you need to have Inspector submit a finding to SNS. Rather than wait 15 minutes for Inspector to finish an assessment though, you can simulate this action.</p> </li> <li> <p>While still in SNS click on Topics on the left hand side</p> </li> <li> <p>Click on the Topic named \"InspectorAutomation\"</p> </li> <li> <p>In the top right click on the button that says \"Publish Message\"</p> <p></p> <p>Using the ARN you copied down in Step 3 of Module 3 you are going to publish a fake SNS message using the appropriate ARN to kick off the Lambda function.</p> <p>What ARN?</p> <p>If you don't have the ARN, you can go back to Inspector and copy the ARN from the Medium finding.</p> </li> <li> <p>Paste the ARN into the appropriate place in the following text: {replace the \"INSERT ARN HERE\" with your arn)</p> <p><code>{\"template\":\"arn:aws:inspector:us-east-1:123456789012:target/0-a12b3c4d/template/0-5e6f7g8h\",\"run\":\"arn:aws:inspector:us-east-1:123456789012:target/0-a12b3c4d/template/0-5e6f7g8h/run/0-9i0j1k2l\",\"time\":\"2019-04-09T00:00:01.401Z\",\"finding\":\"INSERT ARN HERE\",\"event\":\"FINDING_REPORTED\",\"target\":\"arn:aws:inspector:us-east-1:123456789012:target/0-a12b3c4d\"}</code></p> </li> <li> <p>Paste the SNS message from above in the \"Message body to send to the endpoint\" text box</p> </li> <li> <p>Leave all the other fields empty</p> <p></p> </li> <li> <p>Click \"Publish Message\"</p> <p>If you're bored</p> <p><p> Alternatively if you have the time, you can re-run the Inspector report and watch once it's complete to see if the change was made. </p></p> <p>To confirm that it worked you will check the Network ACL's.</p> </li> <li> <p>Click on Services on the top right and click on VPC</p> </li> <li> <p>On the left hand navigation click on Network ACLs</p> <p></p> </li> <li> <p>Since the Proof of Concept VPC is the one with the misconfiguration, click on the ACL associated with that VPC</p> <p></p> </li> <li> <p>On the bottom navigation, click on \"Inbound Rules\"</p> <p></p> <p>Do you see a rule blocking SSH?</p> <p>But if SSH is completely blocked to the instance, how can legitimate administrators configure the machine? Well, they can modify the Security Group and then the NACL through their Change Process. But if they want to make sure the instance wasn't compromised there's another option.</p> </li> <li> <p>Click on Services on the top right and click on Systems Manager</p> </li> <li> <p>On the left hand navigation, click on Session Manager</p> <p></p> </li> <li> <p>On the right hand side click on Start Session</p> <p></p> <p>Do you remember the instance ID with the misconfigured Security Group? If not, don't worry, it was the PoC Web Server for AZ2</p> </li> <li> <p>Click on the radio button next to the instance</p> </li> <li> <p>Click Start Session</p> <p></p> </li> <li> <p>Type \"ping 8.8.8.8\" - Are you able to ping out to the world? Hit Cntl-C when you're ready to move on.</p> </li> <li> <p>Type \"whoami\" - What user are you logged into the box as?</p> <p></p> <p>This looks just like an SSH session! Instead though, this is a proxy created by the AWS System Manager Agent installed on the AMI. With the AWS Systems Manager Session Manager feature you can create an SSH-like access to devices that don't have port 22 open at all. All that's necessary is to allow traffic to the Systems Manager Endpoint over port 443 and return traffic.</p> </li> <li> <p>When you're done, hit \"Terminate\" in the top right corner</p> </li> <li> <p>Confirm you want to terminate the session.</p> </li> </ol> <p>So now we've learned how you can use Inspector to kick off a Lambda function and automatically remediate potentially risks configurations. Additionally, you've seen how when you isolate instances from the world, you can still use AWS services to securely access them and perform troubleshooting or incidence response.</p> <p>Attention</p> <p><p> Now since there are some instances still open to the internet and potentially vulnerable, let's clean up what's been built. </p></p> <p>Cleanup</p>"},{"location":"05-cleanup/","title":"Module 5 - Cleanup","text":"<p>Attention</p> <p><p> The following steps will help you clean up your environment. This is important because the workshop created some publicly accessible instances with vulnerabilities. </p></p> <ol> <li> <p>Delete Assessment Runs - In the Inspector Service, click on Assessment runs, click the box next to all runs, and hit the Delete button.</p> </li> <li> <p>Delete Assessment Templates - In the Inspector Service, click on Assessment templates, click the box next to all templates, and hit the Delete button.</p> </li> <li> <p>Delete Assessment Targets- In the Inspector Service, click on Assessment targets, click the box next to all targets, and hit the Delete button.</p> </li> <li> <p>Delete the SNS Topic Subscriptions - In the SNS Service, click on Subscriptions, click the buttons next to each subscription, and hit the Delete button.</p> </li> <li> <p>Delete CloudFormation Stack - In CloudFormation, click on Stacks, click the radio button next to the stack name you created for the workshop, click the Actions dropdown, and click Delete Stack.</p> </li> <li> <p>Delete EC2 Key Pair (optional) - In the EC2 Service window, click Key Pairs, click the box next to the key pair you created and click Delete.</p> </li> </ol> <p>Congratulations! You have now completed the Amazon Inspector Network Reachability Workshop.</p>"},{"location":"contribute/","title":"Contributing Guidelines","text":"<p>Thank you for your interest in contributing to our project. Whether it's a bug report, new feature, correction, or additional documentation, we greatly value feedback and contributions from our community.</p> <p>Please read through this document before submitting any issues or pull requests to ensure we have all the necessary information to effectively respond to your bug report or contribution.</p>"},{"location":"contribute/#reporting-bugsfeature-requests","title":"Reporting Bugs/Feature Requests","text":"<p>We welcome you to use the GitHub issue tracker to report bugs or suggest features.</p> <p>When filing an issue, please check existing open, or recently closed, issues to make sure somebody else hasn't already reported the issue. Please try to include as much information as you can. Details like these are incredibly useful:</p> <ul> <li>A reproducible test case or series of steps</li> <li>The version of our code being used</li> <li>Any modifications you've made relevant to the bug</li> <li>Anything unusual about your environment or deployment</li> </ul>"},{"location":"contribute/#contributing-via-pull-requests","title":"Contributing via Pull Requests","text":"<p>Contributions via pull requests are much appreciated. Before sending us a pull request, please ensure that:</p> <ol> <li>You are working against the latest source on the master branch.</li> <li>You check existing open, and recently merged, pull requests to make sure someone else hasn't addressed the problem already.</li> <li>You open an issue to discuss any significant work - we would hate for your time to be wasted.</li> </ol> <p>To send us a pull request, please:</p> <ol> <li>Fork the repository.</li> <li>Modify the source; please focus on the specific change you are contributing. If you also reformat all the code, it will be hard for us to focus on your change.</li> <li>Ensure local tests pass.</li> <li>Commit to your fork using clear commit messages.</li> <li>Send us a pull request, answering any default questions in the pull request interface.</li> <li>Pay attention to any automated CI failures reported in the pull request, and stay involved in the conversation.</li> </ol> <p>GitHub provides additional document on forking a repository and creating a pull request.</p>"},{"location":"contribute/#finding-contributions-to-work-on","title":"Finding contributions to work on","text":"<p>Looking at the existing issues is a great way to find something to contribute on. As our projects, by default, use the default GitHub issue labels (enhancement/bug/duplicate/help wanted/invalid/question/wontfix), looking at any 'help wanted' issues is a great place to start.</p>"},{"location":"contribute/#code-of-conduct","title":"Code of Conduct","text":"<p>This project has adopted the Amazon Open Source Code of Conduct. For more information see the Code of Conduct FAQ or contact opensource-codeofconduct@amazon.com with any additional questions or comments.</p>"},{"location":"contribute/#security-issue-notifications","title":"Security issue notifications","text":"<p>If you discover a potential security issue in this project we ask that you notify AWS/Amazon Security via our vulnerability reporting page. Please do not create a public github issue.</p>"},{"location":"contribute/#licensing","title":"Licensing","text":"<p>See the LICENSE file for our project's licensing. We will ask you to confirm the licensing of your contribution.</p> <p>We may ask you to sign a Contributor License Agreement (CLA) for larger changes.</p>"},{"location":"license/","title":"License","text":"<pre><code>                             Apache License\n                       Version 2.0, January 2004\n                    http://www.apache.org/licenses/\n</code></pre> <p>TERMS AND CONDITIONS FOR USE, REPRODUCTION, AND DISTRIBUTION</p> <ol> <li> <p>Definitions.</p> <p>\"License\" shall mean the terms and conditions for use, reproduction,   and distribution as defined by Sections 1 through 9 of this document.</p> <p>\"Licensor\" shall mean the copyright owner or entity authorized by   the copyright owner that is granting the License.</p> <p>\"Legal Entity\" shall mean the union of the acting entity and all   other entities that control, are controlled by, or are under common   control with that entity. For the purposes of this definition,   \"control\" means (i) the power, direct or indirect, to cause the   direction or management of such entity, whether by contract or   otherwise, or (ii) ownership of fifty percent (50%) or more of the   outstanding shares, or (iii) beneficial ownership of such entity.</p> <p>\"You\" (or \"Your\") shall mean an individual or Legal Entity   exercising permissions granted by this License.</p> <p>\"Source\" form shall mean the preferred form for making modifications,   including but not limited to software source code, documentation   source, and configuration files.</p> <p>\"Object\" form shall mean any form resulting from mechanical   transformation or translation of a Source form, including but   not limited to compiled object code, generated documentation,   and conversions to other media types.</p> <p>\"Work\" shall mean the work of authorship, whether in Source or   Object form, made available under the License, as indicated by a   copyright notice that is included in or attached to the work   (an example is provided in the Appendix below).</p> <p>\"Derivative Works\" shall mean any work, whether in Source or Object   form, that is based on (or derived from) the Work and for which the   editorial revisions, annotations, elaborations, or other modifications   represent, as a whole, an original work of authorship. For the purposes   of this License, Derivative Works shall not include works that remain   separable from, or merely link (or bind by name) to the interfaces of,   the Work and Derivative Works thereof.</p> <p>\"Contribution\" shall mean any work of authorship, including   the original version of the Work and any modifications or additions   to that Work or Derivative Works thereof, that is intentionally   submitted to Licensor for inclusion in the Work by the copyright owner   or by an individual or Legal Entity authorized to submit on behalf of   the copyright owner. For the purposes of this definition, \"submitted\"   means any form of electronic, verbal, or written communication sent   to the Licensor or its representatives, including but not limited to   communication on electronic mailing lists, source code control systems,   and issue tracking systems that are managed by, or on behalf of, the   Licensor for the purpose of discussing and improving the Work, but   excluding communication that is conspicuously marked or otherwise   designated in writing by the copyright owner as \"Not a Contribution.\"</p> <p>\"Contributor\" shall mean Licensor and any individual or Legal Entity   on behalf of whom a Contribution has been received by Licensor and   subsequently incorporated within the Work.</p> </li> <li> <p>Grant of Copyright License. Subject to the terms and conditions of       this License, each Contributor hereby grants to You a perpetual,       worldwide, non-exclusive, no-charge, royalty-free, irrevocable       copyright license to reproduce, prepare Derivative Works of,       publicly display, publicly perform, sublicense, and distribute the       Work and such Derivative Works in Source or Object form.</p> </li> <li> <p>Grant of Patent License. Subject to the terms and conditions of       this License, each Contributor hereby grants to You a perpetual,       worldwide, non-exclusive, no-charge, royalty-free, irrevocable       (except as stated in this section) patent license to make, have made,       use, offer to sell, sell, import, and otherwise transfer the Work,       where such license applies only to those patent claims licensable       by such Contributor that are necessarily infringed by their       Contribution(s) alone or by combination of their Contribution(s)       with the Work to which such Contribution(s) was submitted. If You       institute patent litigation against any entity (including a       cross-claim or counterclaim in a lawsuit) alleging that the Work       or a Contribution incorporated within the Work constitutes direct       or contributory patent infringement, then any patent licenses       granted to You under this License for that Work shall terminate       as of the date such litigation is filed.</p> </li> <li> <p>Redistribution. You may reproduce and distribute copies of the       Work or Derivative Works thereof in any medium, with or without       modifications, and in Source or Object form, provided that You       meet the following conditions:</p> <p>(a) You must give any other recipients of the Work or       Derivative Works a copy of this License; and</p> <p>(b) You must cause any modified files to carry prominent notices       stating that You changed the files; and</p> <p>(c) You must retain, in the Source form of any Derivative Works       that You distribute, all copyright, patent, trademark, and       attribution notices from the Source form of the Work,       excluding those notices that do not pertain to any part of       the Derivative Works; and</p> <p>(d) If the Work includes a \"NOTICE\" text file as part of its       distribution, then any Derivative Works that You distribute must       include a readable copy of the attribution notices contained       within such NOTICE file, excluding those notices that do not       pertain to any part of the Derivative Works, in at least one       of the following places: within a NOTICE text file distributed       as part of the Derivative Works; within the Source form or       documentation, if provided along with the Derivative Works; or,       within a display generated by the Derivative Works, if and       wherever such third-party notices normally appear. The contents       of the NOTICE file are for informational purposes only and       do not modify the License. You may add Your own attribution       notices within Derivative Works that You distribute, alongside       or as an addendum to the NOTICE text from the Work, provided       that such additional attribution notices cannot be construed       as modifying the License.</p> <p>You may add Your own copyright statement to Your modifications and   may provide additional or different license terms and conditions   for use, reproduction, or distribution of Your modifications, or   for any such Derivative Works as a whole, provided Your use,   reproduction, and distribution of the Work otherwise complies with   the conditions stated in this License.</p> </li> <li> <p>Submission of Contributions. Unless You explicitly state otherwise,       any Contribution intentionally submitted for inclusion in the Work       by You to the Licensor shall be under the terms and conditions of       this License, without any additional terms or conditions.       Notwithstanding the above, nothing herein shall supersede or modify       the terms of any separate license agreement you may have executed       with Licensor regarding such Contributions.</p> </li> <li> <p>Trademarks. This License does not grant permission to use the trade       names, trademarks, service marks, or product names of the Licensor,       except as required for reasonable and customary use in describing the       origin of the Work and reproducing the content of the NOTICE file.</p> </li> <li> <p>Disclaimer of Warranty. Unless required by applicable law or       agreed to in writing, Licensor provides the Work (and each       Contributor provides its Contributions) on an \"AS IS\" BASIS,       WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or       implied, including, without limitation, any warranties or conditions       of TITLE, NON-INFRINGEMENT, MERCHANTABILITY, or FITNESS FOR A       PARTICULAR PURPOSE. You are solely responsible for determining the       appropriateness of using or redistributing the Work and assume any       risks associated with Your exercise of permissions under this License.</p> </li> <li> <p>Limitation of Liability. In no event and under no legal theory,       whether in tort (including negligence), contract, or otherwise,       unless required by applicable law (such as deliberate and grossly       negligent acts) or agreed to in writing, shall any Contributor be       liable to You for damages, including any direct, indirect, special,       incidental, or consequential damages of any character arising as a       result of this License or out of the use or inability to use the       Work (including but not limited to damages for loss of goodwill,       work stoppage, computer failure or malfunction, or any and all       other commercial damages or losses), even if such Contributor       has been advised of the possibility of such damages.</p> </li> <li> <p>Accepting Warranty or Additional Liability. While redistributing       the Work or Derivative Works thereof, You may choose to offer,       and charge a fee for, acceptance of support, warranty, indemnity,       or other liability obligations and/or rights consistent with this       License. However, in accepting such obligations, You may act only       on Your own behalf and on Your sole responsibility, not on behalf       of any other Contributor, and only if You agree to indemnify,       defend, and hold each Contributor harmless for any liability       incurred by, or claims asserted against, such Contributor by reason       of your accepting any such warranty or additional liability.</p> </li> </ol>"},{"location":"presentation-notes/","title":"Optional: Presentation Notes","text":"<p>While the environment is building let\u2019s talk about what this represents. Remember, this scenario is comprised of a new company that has been in AWS for a few months and are moving their first few workloads in the cloud. The CloudFormation template is modeling their environment. The first workload to move was an external website with a database back end. Security insisted that access to those servers only be through a set of bastion hosts in a separate VPC. Recently, a developer has created a public proof of concept for a new highly available web service and connected it to the environment without going through all the proper change management. The developer did the right thing by putting two different servers in two different availability zones. But since the two AZs have different Security Groups, each with different port filtering setup, the workload may not be able to successfully failover correctly. The various IT stakeholders have been working off some assumptions but have not had the chance to test them yet.</p> <p>Assumption 1.&gt; Instances in private subnets are not accessible from the internet</p> <p>Assumption 2.&gt; Putting servers in different Availability zones provide failover and better reliability</p> <p>Assumption 3.&gt; Nothing can route through the bastion VPC.</p> <p>Assumption 4.&gt; Access to the servers is limited by least privilege</p> <p>Assumption 5.&gt; The bastion hosts can access all environments</p> <p>The IT team found the developer\u2019s new environment not because of controls, but because the bill came back above budget. Now the security and operations team want to validate the right security is applied to the new environment as well as the existing one. They will use the Network Reachability report in Amazon Inspector to provide them validation of their network assumptions. This is a recent addition to Inspector, going public in November of 2018. </p> <p>Let\u2019s look at their architecture on Slide 2.</p> <p>Example Corp. has isolated workloads by VPC and has used VPC peering to meet some connectivity assumptions. You can see they tried to build public and private subnets, but we have to dig deeper to see what\u2019s actually going on there. Their production web app on the left has a load balancer in front of it, which is great. But you can see the PoC environment is not as mature.</p> <p>Before we dive too deep though, let\u2019s go back and see what the built environment looks like.</p> <p>Running the Inspector Report</p>"},{"location":"presentation-notes/#module-2-architecture-review","title":"Module 2 - Architecture Review","text":"<p>Let\u2019s go back to the architecture we looked at earlier. We know we need more information to better understand the data flows and connectivity. So let\u2019s dig deeper to see if they designed everything right.</p> <p>Let\u2019s look at the route tables they\u2019ve built. Slide 3 contains all of the information regarding routes in their environment.</p> <p>Right away we see that something named \u201cPublic Route\u201d applies to the Database subnets. What else can we glean from these? For example, what IP address range is their corporate office?</p> <p>Okay, let\u2019s look at the Security Groups on Slide 4.</p> <p>So here we see some good things and some troubling things as well. The Load Balancer and Web Server look like they\u2019ve been configured well. They both use Security Group references instead of CIDR blocks to allow access. But the database server Security group is in trouble. Rather than using the Web Server Security Group it looks like it\u2019s set to everyone. The route table misconfiguration we saw earlier can mean this is a real problem.</p> <p>What about the Bastion Server security group and CIDR blocks. Is there a better way to handle those? For example, is there a better way than IP addresses to reference groups of servers in AWS?</p> <p>There are more Security Groups on Slide 5. The PoC environment specifically. What do you see wrong here? </p> <p>Let\u2019s go back to the assumptions we talked about earlier. Slide 6 has a refresher. We can walk through each of these individually in the following slides.</p> <ol> <li> <p>Let\u2019s talk about Assumption 1 the Security Team put in place. Assuming a properly architected three-tier web application, do the Web or DB Subnets need to be open to the internet for the website to work?</p> <ul> <li>No. The only group that needs to be public is the Security Group for the Load Balancers.</li> </ul> </li> <li> <p>What does a properly secured solution look like from a data flow perspective? What subnets or instances need to be public?</p> <ul> <li>The Load Balancer in the public subnet needs to be public. But the webserver can have port 80 locked down to only be accessible from the Load Balancers. The Web server security group can enforce this. The Database subnet and servers can also be locked down to just the Web servers by using Security Group associations. To meet the security requirement, SSH and RDP can also be locked down to the Bastion servers.</li> </ul> </li> <li> <p>Can the Bastion servers be referenced by Security Group, or just IP address range?</p> <ul> <li>Security groups can be shared across VPC Peers when the proper approvals are put in place.</li> </ul> </li> <li> <p>What about the Bastion hosts? How do we use Ingress and Egress Security Group rules in Security Groups to control their access?</p> <ul> <li>Only requests coming from on-premises should be able to SSH or RDP into the Bastion servers. This is limited by Ingress rules. The Bastion hosts can then only talk to the servers it has been approved to talk to. This is controlled by Egress Rules.</li> </ul> </li> <li> <p>What about Assumption 2? What should we look at to validate if this is true and does this diagram look right?</p> <ul> <li>We would want to look at Routing Tables and NACL\u2019s for subnets, Security Groups for Instances, and NAT and Internet Gateways in VPC\u2019s. In this case, the WebApp VPC looks both good and bad. The Security Groups are shared and the routing tables are the same between the subnets in different AZ\u2019s. The single NAT Gateway is not ideal but does minimize the number of route tables necessary reducing the risk of a misconfiguration. The Bastion VPC looks setup correctly. The route tables and security groups look right. For the Proof of Concept VPC though there\u2019s a lot wrong. There\u2019s no need to split the security group and in doing so many of the rules are incorrect. This means that the Availability Zone failover won\u2019t work right.</li> </ul> </li> <li> <p>But if the WebApp VPC and Proof of Concept VPC are both connected to the Bastion VPC, can\u2019t they talk to each other too? (Assumption 3)</p> <ul> <li>No. AWS VPC\u2019s are not transitive in nature. Routing is basically a single hop only for VPC Peering. Now that can be changed with Transit VPC\u2019s, 3rd party tools, or instances acting like routers, but in general VPC Peering does not have transitive properties. The Network Reachability report will show us this.</li> </ul> </li> <li> <p>So we\u2019ve talked about the routing to each subnet and server, but what about the Security Groups. For Assumption 4 what are the best ways to accomplish and validate least privilege? How can we use automated checks to validate this instead of doing it manually? </p> <ul> <li> <p>To accomplish least privilege each Security Group should map to other Security Groups. For example: The Web Servers should have an ingress rule only allowing traffic from the Load Balancers on Port 80, and the Database Servers should only have an ingress rule from the Web Servers from port 3306. Even across VPC Peers it\u2019s possible to use Security Groups to only allow traffic from the Bastion Hosts to instances in the WebApp VPC if peering allows for it.</p> <p>But to validate this manually is time consuming and error prone, especially in large environments. So instead, using things like the Inspector Reachability Report we can validate certain assumptions. For example, making sure that only Web Servers can talk to Database servers. So even in non-ideal scenarios, where IP blocks are used to allow access, we can check to make sure instances aren\u2019t accessible from the internet. Or if they are, that Security Groups block their access. This is Defense in Depth.</p> </li> </ul> </li> <li> <p>Given that sometimes changes happen without people\u2019s knowledge, how can we confirm what\u2019s accessible? For example, when the developer built the Proof of Concept space, they built a peer relationship and routed to the Bastion hosts. Can they connect?</p> <ul> <li>No. The developer did a good job of building connectivity to the Bastion VPC, but the Bastion VPC does not have the proper routing or Security Group rules to allow access to the PoCVPC. Both would need to be added to provide connectivity. The Network Reachability report shows this too.</li> </ul> </li> </ol> <p>So then let\u2019s go to Evaluating Findings to look at how the report helps us validate these assumptions or findings.</p>"},{"location":"presentation-notes/#frequently-asked-questions","title":"Frequently Asked Questions","text":"<ol> <li> <p>Does it replace a vulnerability scan?</p> <ol> <li>No. This will tell you what servers can talk to what, but it doesn\u2019t give you details of everything installed on those servers. When used in conjunction with other Inspector reports you do get closer to a full vulnerability scan, but you may want to compare to existing tools in your environment.</li> </ol> </li> <li> <p>Are you sending real traffic?</p> <ol> <li>No. The Network Reachability report uses the Zelkova framework inside of AWS to create mathematical proofs of communication channels. No actual packets are sent in the network. You can find out more at: https://aws.amazon.com/security/provable-security/</li> </ol> </li> <li> <p>Is the agent open source?</p> <ol> <li>Not at this time.</li> </ol> </li> <li> <p>What operating systems support the Amazon Inspector Agent?</p> <ol> <li>Certain Amazon provided AMI\u2019s come with the Inspector agent already installed, and those will be notes in the title with \u201cwith Amazon Inspector Agent\u201d. You can find the complete list of supported operating systems in the AWS documentation at: https://docs.aws.amazon.com/inspector/latest/userguide/inspector_supported_os_regions.html</li> </ol> </li> <li> <p>Is the agent running as root?</p> <ol> <li>When installed following the AWS documentation, yes. More information can be found here: https://docs.aws.amazon.com/inspector/latest/userguide/inspector_agents.html.</li> </ol> </li> <li> <p>Does the agent need a TCP/UDP port to be open?</p> <ol> <li>Yes. Outbound 443 to the Inspector and S3 (for logging) service endpoints is required. Please see the documentation at https://docs.aws.amazon.com/inspector/latest/userguide/inspector_agents.html for more details.</li> </ol> </li> </ol>"}]}