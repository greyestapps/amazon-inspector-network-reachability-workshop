
<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
        <meta name="description" content="The workshop will demonstrate how you can validate their network configuration without needing to have a deep networking background by using Inspectors Network Reachability report. You will learn how this report can help them find misconfigurations in the architecture or behaviors they might not have expected. The demo will finish with using the Network Reachability report findings integrated with other Security Services to remediate these issues.">
      
      
        <meta name="author" content="aws-security-workshops@amazon.com">
      
      
      
        <link rel="prev" href="../02-running-inspector/">
      
      
        <link rel="next" href="../04-integration-and-remediation/">
      
      <link rel="icon" href="../images/aws-favicon.ico">
      <meta name="generator" content="mkdocs-1.4.2, mkdocs-material-9.1.2">
    
    
      
        <title>Module 3: Evaluating Findings - Finding and addressing Network Misconfigurations on AWS</title>
      
    
    
      <link rel="stylesheet" href="../assets/stylesheets/main.7bf56d0a.min.css">
      
        
        <link rel="stylesheet" href="../assets/stylesheets/palette.a0c5b2b5.min.css">
      
      

    
    
    
      
        
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&display=fallback">
        <style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style>
      
    
    
      <link rel="stylesheet" href="../stylesheets/custom.css">
    
    <script>__md_scope=new URL("..",location),__md_hash=e=>[...e].reduce((e,_)=>(e<<5)-e+_.charCodeAt(0),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
    
      

    
    
    
  </head>
  
  
    
    
    
    
    
    <body dir="ltr" data-md-color-scheme="default" data-md-color-primary="" data-md-color-accent="">
  
    
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#module-3-evaluating-findings" class="md-skip">
          Skip to content
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
    
      

  

<header class="md-header md-header--shadow" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="Header">
    <a href=".." title="Finding and addressing Network Misconfigurations on AWS" class="md-header__button md-logo" aria-label="Finding and addressing Network Misconfigurations on AWS" data-md-component="logo">
      
  <img src="../images/aws_smile_logo.png" alt="logo">

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3V6m0 5h18v2H3v-2m0 5h18v2H3v-2Z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            Finding and addressing Network Misconfigurations on AWS
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              Module 3: Evaluating Findings
            
          </span>
        </div>
      </div>
    </div>
    
    
    
      <label class="md-header__button md-icon" for="__search">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5Z"/></svg>
      </label>
      <div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="Search" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" required>
      <label class="md-search__icon md-icon" for="__search">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5Z"/></svg>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12Z"/></svg>
      </label>
      <nav class="md-search__options" aria-label="Search">
        
        <button type="reset" class="md-search__icon md-icon" title="Clear" aria-label="Clear" tabindex="-1">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12 19 6.41Z"/></svg>
        </button>
      </nav>
      
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            Initializing search
          </div>
          <ol class="md-search-result__list" role="presentation"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
    
    
  </nav>
  
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
          
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    


<nav class="md-nav md-nav--primary" aria-label="Navigation" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href=".." title="Finding and addressing Network Misconfigurations on AWS" class="md-nav__button md-logo" aria-label="Finding and addressing Network Misconfigurations on AWS" data-md-component="logo">
      
  <img src="../images/aws_smile_logo.png" alt="logo">

    </a>
    Finding and addressing Network Misconfigurations on AWS
  </label>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href=".." class="md-nav__link">
        Overview
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../01-environment-setup/" class="md-nav__link">
        Module 1: Environment Build and Configuration
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../02-running-inspector/" class="md-nav__link">
        Module 2: Running Inspector
      </a>
    </li>
  

    
      
      
      

  
  
    
  
  
    <li class="md-nav__item md-nav__item--active">
      
      <input class="md-nav__toggle md-toggle" type="checkbox" id="__toc">
      
      
        
      
      
      <a href="./" class="md-nav__link md-nav__link--active">
        Module 3: Evaluating Findings
      </a>
      
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../04-integration-and-remediation/" class="md-nav__link">
        Module 4: Integration and Remediation
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../05-cleanup/" class="md-nav__link">
        Module 5: Cleanup
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../contribute/" class="md-nav__link">
        Contributing
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../license/" class="md-nav__link">
        License
      </a>
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              
              <div class="md-sidebar md-sidebar--secondary" data-md-component="sidebar" data-md-type="toc" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
</nav>
                  </div>
                </div>
              </div>
            
          
          
            <div class="md-content" data-md-component="content">
              <article class="md-content__inner md-typeset">
                
                  


<h1 id="module-3-evaluating-findings">Module 3 - Evaluating Findings</h1>
<p>In the previous module you activated Amazon Inspector. In this module you will evaluate the various findings generated by Inspector and identify potential mitigations. You will use these findings to evaluate the assumptions discussed in the start of the workshop. For reference they are:</p>
<p><strong>Assumption 1.</strong> Instances in private subnets are not accessible from the internet</p>
<p><strong>Assumption 2.</strong> Putting servers in different Availability zones provides both failover and better reliability</p>
<!-- __Assumption 3.__ Nothing can route through the bastion VPC -->

<p><strong>Assumption 3.</strong> Access to the servers is limited according to the principle of least privilege</p>
<p><strong>Assumption 4.</strong> The bastion hosts can access all environments</p>
<h1 id="evaluating-the-inspector-findings">Evaluating the Inspector Findings</h1>
<p>Let's look at the Inspector Network Reachability findings and see what we can learn.</p>
<ol>
<li>
<p>Go back to the Inspector console and select Findings from the navigation bar on the left.</p>
</li>
<li>
<p>Click on the <em>Add Filter</em> input field and filter for <em>Type</em> of <em>NETWORK_REACHABILITY</em></p>
<p><img alt="" src="../images/mod3-filter-type.png" /></p>
<!-- !!! info "Inspector Agent delay"
    If you see multiple Medium findings and none of the findings indicate the Inspector agent was running, you will need to delete the Assessment and run it again. This means the instances did not have the Inspector agent running at the time of the scan. The agent is installed, it may just have been coming active. -->
<p>To begin, you will start evaluating the higher severity findings. So let’s take a look at a Medium finding first.</p>
</li>
<li>
<p>Select the first Medium finding starting with <em>Port 22 is reachable...</em> by clicking the checkbox to the left of <em>Medium</em></p>
<p><img alt="" src="../images/mod3-medium-finding.png" /></p>
<p>Our instance is reachable via SSH from the Internet. First, let's find out which instance that is. Click on the link for the Resource ID under <em>Resource affected</em>. Looking at the name this is our PoC Web Server in AZ2. We should not expose this via port 22 to the Internet. </p>
</li>
<li>
<p>How to remediate? Inspector tells us at the bottom under <em>Remediation</em> that we can restrict the access to our instance via the Security Group or Access Control List.</p>
<p>In the <em>Open Network Paths</em> section click on <em>Security Group</em> and copy the Security Group ID or simply click the blue link. Next switch to <a href="https://eu-west-1.console.aws.amazon.com/ec2/v2/home?region=eu-west-1#SecurityGroups:">Security Groups</a> and enter the id in the search bar.
<img alt="" src="../images/mod3-sg.png" />
Click on the <em>Inbound rules</em> which reveals that port 22 for SSH is open to the world. That means <em>Assumption 3. Access to the servers is limited according to the principle of least privilege</em> is wrong. This is something you would want addressed first.</p>
<p>So since you know some things are wrong, let’s check the other findings for this server. You do that by filtering by the instance ID.</p>
</li>
<li>
<p>Go back to Inspector and in the Findings view add another filter for <em>Resource ID</em> that equals your instance id (you can copy the instance id from the first finding).
    <img alt="" src="../images/mod3-finding443.png" />
    There's another finding for our WebServer instance indicating that port 443 is exposed to the internet. Given we are serving a website and this is a HTTPS port the severity is low. We could put the WebServers into private subnets and only expose the LoadBalancer into the public subnet, but let's focus on understanding the other findings as well.</p>
</li>
<li>
<p>Going back to the Medium finding with port 22 being exposed to the internet let us check if other instances are affected by this as well. In the Findings view remove the filter for the instance id. Add a new filter for <em>Open port</em> from <em>22</em> to <em>22</em>.</p>
<p>As we can see luckily only our WebServer for AZ2 is affected.</p>
</li>
<li>
<p>Remove the filter for the <em>Open port</em> and let's have a look at the other <em>Medium</em> findings. As we can see there are 2 instances with port 3306 reachable from the internet. Click on one of these findings and follow the link to the affected resource. As it turns out this is one of our database servers. Looking at the second finding with port 3306 being reachable from the internet shows that actually both our database servers are impacted by this. This is for sure a security concern, databases should reside in private subnets and not being accessible from the internet. So <em>Assumption 1. Instances in private subnets are not accessible from the internet</em> is broken as well. If the subnet would have been setup correctly (meaning no route to an Internet Gateway in the respective RouteTable) the assumption would have been correct.</p>
</li>
<li>
<p>As we looked at all the Medium findings let us now investigate the others with low severity. You can add another filter for severity low.
    <img alt="" src="../images/mod3-low.png" />
   We already looked at the finding with port 443. However, somethings seems odd about the number of findings here. We have 4 WebServers in total, 2 in prod and 2 for our PoC. On the other hand we have 3 findings for Port 80 and one for port 443 being exposed to the internet.</p>
</li>
<li>
<p>Go to the EC2 console and filter for <em>Web Server</em> or simply click <a href="https://eu-west-1.console.aws.amazon.com/ec2/v2/home?region=eu-west-1#Instances:search=:web%20server;v=3;$case=tags:true%5C,client:false;$regex=tags:false%5C,client:false">this link</a>. Have a look at the <em>Availability Zone</em> column. We see that we have one instance of Web Server and PoC Web Server per AZ (here <em>eu-west-1a</em> and <em>eu-west-1b</em>, yours might differ). <img alt="" src="../images/mod3-azs.png" /> So <em>Assumption 2. Putting servers in different Availability zones provides both failover and better reliability</em> seems to be valid. Is it? If there should be an event in one AZ and we want to fail over the instances have to listen on the same ports to make this work. </p>
</li>
<li>
<p>Let's go back to the Findings view of Inspector, filtering for severity low. Three instances are listening on port 80, one on port 443 (all instances ids in column <em>Impacted resource</em> are different for this filter). <img alt="" src="../images/mod3-low-instance.png" /> Therefor an failover to our <em>PoC Web Server for AZ2</em> would fail, breaking assumption 2.</p>
</li>
<li>
<p>Now what about <em>Assumption 4. The bastion hosts can access all environments</em>? Here we come back to our instance coverage of only 75%. In Inspector go to the <a href="https://eu-west-1.console.aws.amazon.com/inspector/v2/home?region=eu-west-1#/dashboard">dashboard</a> and click on the blue 75%. <img alt="" src="../images/mod3-instance-coverage.png" />The status column reveals that both of our Bastion hosts are unmanaged, meaning they are not scanned by Inspector. At this point we do not dive into why that is and how to fix it. We take it as a learning that there might be resources that we did not configure in a way to be included in the scans of Inspector. So in order to verify assumption 4 we will use a different tool.</p>
</li>
<li>
<p>You might have seen the blue banner in step 4, where we investigated a security group. It tells that we can check network connectivity with the Reachability Analyzer which is part of the AWS Network Manager. Let's <a href="https://eu-west-1.console.aws.amazon.com/networkinsights/home?region=eu-west-1#ReachabilityAnalyzer">pay it a visit</a>.</p>
</li>
<li>
<p>Let us check if there is connectivity from <em>Bastion Server for AZ1</em> to the <em>Database Server for AZ1</em>. Click on <em>Create and analyze path</em>. As <em>Source type</em> select <em>instances</em> and <em>Bastion Server for AZ1</em>. As <em>Destination type</em> select <em>instances</em> and <em>Database Server for AZ1</em>. Leave the rest as it is and click on <em>Create and anapyze path</em>. The analyzsis will take a couple of seconds.</p>
</li>
<li>
<p>You should get a success for reachability, meaning both instances can connect. Repeat step 13, this time with <em>Source type</em> of <em>Bastion Server for AZ1</em> and destination as <em>PoC Web Server for AZ1</em></p>
</li>
<li>
<p>This time Reachability Analyzer tells us that <em>PoC Web Server for AZ1</em> is not reachable from <em>Bastion Server for AZ1</em>. <img alt="" src="../images/mod3-reach.png" /> We could even look into the path details to find out the root cause of that connectivity failing. However, at this point let us conclude that <em>Assumption 4. The bastion hosts can access all environments</em> is proven wrong as well.</p>
</li>
</ol>
<!-- 4.  Highlight the AWS agent ID, copy it, and scroll back to the top to paste the Instance ID of the offending instance in the “Filter”

    ![](./images/mod3-4-instance-search.png)

    Hover over the finding titles with your mouse. You will immediately see multiple findings about Peered connections, one Low and the top three Informational findings. Since you already looked at the SSH finding and know you need to address that, let’s look at the Informational finding for this peered connection. -->

<!-- 5.  Expand the “Finding” Column so you can see enough of the title to see “Peered”

6.  Expand the Informational finding that starts with “Aggregate network exposure” and has “Peered”

    ![](./images/mod3-5-finding2.png)

7.  Check what VPC is peered. Click on the VPC Peering Connection link in the finding to open it in a new window. Note the peer name.

8.  Click on the VPC peer name from the finding.

9.  Click on the Requester VPC in the bottom window.

    Here you see the peer is to the Bastion VPC. This is okay because you expect this behavior. What you don’t see, however, is anything about connectivity from the WebApp VPC. That’s because the report knows there’s no way to transit through multiple VPC Peering connections today. So this helps you validate Assumption 3 is true as long as there’s no additional routing the report can’t see (for example a Cisco CSR Transit VPC). But this also means Assumption 5 is false because there is no Peer between the Bastion VPC and the Proof of Concept.

    What about the multiple Availability Zone configuration though for this Proof of Concept? Given the misconfiguration, you should check Assumption 2. Since you want to check against multiple Instances, let’s filter by VPC, in this case the PoCVPC. -->

<!-- 10.  Close the preview window and go back to the findings. Scroll back to the top and put the VPC ID of the offending instance in the “Filter”. Collapse the first finding you had open.

    ![](./images/mod3-6-vpc-search.png)

    Next, you want to compare the Internet reachability. The most relevant findings related to internet access are the “Aggregate network exposure” findings. Those are found half way down the list. Comparing them visually you will see one instance only has port 80 open. 

11.  Expand the first finding that starts with “Aggregate network exposure” and has “internet”.

    ![](./images/mod3-7-finding3.png)

12.  Notice only port 80 is open. Collapse this finding.

13.  Expand the second finding that starts with “Aggregate network exposure” and has “internet” – it will have a different instance ID.

    ![](./images/mod3-8-finding4.png)

    Here you see the other instance has ports 22 and 443 open.

    This would indicate than in a failover scenario the second instance would fail to respond to any HTTP traffic. So this must be fixed for failover to work. Assumption 2 is proven false.

    The remaining assumption, Assumption 1, related to the Private Subnets, so let's move on from the POC Server side. You have a couple of things you need to address so can send this report to the developer to have them fix things. Let’s start looking at the WebApp side. Notice the route table for the Database subnet is incorrect, so let’s see if that is having any security impact. Again you can filter by the instance ID, or something you expect to see in the finding. For example, let’s filter by the port number: 3306. -->

<!-- 14.  Collapse the open findings. Scroll back to the top and put “3306” in the “Filter”

    ![](./images/mod3-9-port-search.png)

    Here you are looking for instances open to the internet on this port. One of the first findings indicate the instance has ports are reachable from the internet.

15.  Expand the finding that starts with “Aggregate network exposure” and has “internet”

    ![](./images/mod3-10-finding5.png)

    From the naming context you know this is wrong since this instance shouldn't have access from the internet. But rather than following this one recommendation, you can also to apply a different route table to the subnet. This just shows how there are different ways to solve the same problem, but it requires context. This is a good example where defense in depth is important. You may have set the Security Group to 0.0.0.0/0 for testing or internal access purposes, but because of a bad assumption you potentially put your entire environment at risk.

    In the end this proves Assumption 1 was false and needs to be revisited for all servers.

!!! info "Alternative methods of analysis"
        There’s another way to compare instance findings like this. You can download all of these findings in a .csv file, allowing you to sort, filter, and compare much more programmatically. We choose not to do this to provide a consistent experience for all participants. -->

<h1 id="take-aways">Take Aways</h1>
<p>Thanks to the Inspector and Reachability Analyzer you were able to show that all of our assumptions had problems due to misconfigurations.</p>
<p>But now what? You don't want to leave these issues as they are, so let's see how to remediate them by combining other AWS tools and services. <a href="../04-integration-and-remediation/">Integration and Remediation</a> will do just that.</p>





                
              </article>
            </div>
          
          
        </div>
        
      </main>
      
        <footer class="md-footer">
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-copyright">
  
    <div class="md-copyright__highlight">
      <a href="https://aws.amazon.com/privacy/" target="_blank">Privacy</a> | <a href="https://aws.amazon.com/terms/" target="_blank">Site terms</a> | &copy; 2023, Amazon Web Services, Inc. or its affiliates. All rights reserved.
    </div>
  
  
    Made with
    <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
      Material for MkDocs
    </a>
  
</div>
      
    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    
    <script id="__config" type="application/json">{"base": "..", "features": [], "search": "../assets/javascripts/workers/search.208ed371.min.js", "translations": {"clipboard.copied": "Copied to clipboard", "clipboard.copy": "Copy to clipboard", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.placeholder": "Type to start searching", "search.result.term.missing": "Missing", "select.version": "Select version"}}</script>
    
    
      <script src="../assets/javascripts/bundle.fc8c2696.min.js"></script>
      
    
  </body>
</html>