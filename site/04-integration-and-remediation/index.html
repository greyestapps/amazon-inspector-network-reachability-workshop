
<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
        <meta name="description" content="The workshop will demonstrate how you can validate their network configuration without needing to have a deep networking background by using Inspectors Network Reachability report. You will learn how this report can help them find misconfigurations in the architecture or behaviors they might not have expected. The demo will finish with using the Network Reachability report findings integrated with other Security Services to remediate these issues.">
      
      
        <meta name="author" content="aws-security-workshops@amazon.com">
      
      
      
        <link rel="prev" href="../03-evaluate-findings/">
      
      
        <link rel="next" href="../05-cleanup/">
      
      <link rel="icon" href="../images/aws-favicon.ico">
      <meta name="generator" content="mkdocs-1.4.2, mkdocs-material-9.1.2">
    
    
      
        <title>Module 4: Integration and Remediation - Finding and addressing Network Misconfigurations on AWS</title>
      
    
    
      <link rel="stylesheet" href="../assets/stylesheets/main.7bf56d0a.min.css">
      
        
        <link rel="stylesheet" href="../assets/stylesheets/palette.a0c5b2b5.min.css">
      
      

    
    
    
      
        
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&display=fallback">
        <style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style>
      
    
    
      <link rel="stylesheet" href="../stylesheets/custom.css">
    
    <script>__md_scope=new URL("..",location),__md_hash=e=>[...e].reduce((e,_)=>(e<<5)-e+_.charCodeAt(0),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
    
      

    
    
    
  </head>
  
  
    
    
    
    
    
    <body dir="ltr" data-md-color-scheme="default" data-md-color-primary="" data-md-color-accent="">
  
    
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#module-4-integration-and-remediation" class="md-skip">
          Skip to content
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
    
      

  

<header class="md-header md-header--shadow" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="Header">
    <a href=".." title="Finding and addressing Network Misconfigurations on AWS" class="md-header__button md-logo" aria-label="Finding and addressing Network Misconfigurations on AWS" data-md-component="logo">
      
  <img src="../images/aws_smile_logo.png" alt="logo">

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3V6m0 5h18v2H3v-2m0 5h18v2H3v-2Z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            Finding and addressing Network Misconfigurations on AWS
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              Module 4: Integration and Remediation
            
          </span>
        </div>
      </div>
    </div>
    
    
    
      <label class="md-header__button md-icon" for="__search">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5Z"/></svg>
      </label>
      <div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="Search" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" required>
      <label class="md-search__icon md-icon" for="__search">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5Z"/></svg>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12Z"/></svg>
      </label>
      <nav class="md-search__options" aria-label="Search">
        
        <button type="reset" class="md-search__icon md-icon" title="Clear" aria-label="Clear" tabindex="-1">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12 19 6.41Z"/></svg>
        </button>
      </nav>
      
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            Initializing search
          </div>
          <ol class="md-search-result__list" role="presentation"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
    
    
  </nav>
  
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
          
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    


<nav class="md-nav md-nav--primary" aria-label="Navigation" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href=".." title="Finding and addressing Network Misconfigurations on AWS" class="md-nav__button md-logo" aria-label="Finding and addressing Network Misconfigurations on AWS" data-md-component="logo">
      
  <img src="../images/aws_smile_logo.png" alt="logo">

    </a>
    Finding and addressing Network Misconfigurations on AWS
  </label>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href=".." class="md-nav__link">
        Overview
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../01-environment-setup/" class="md-nav__link">
        Module 1: Environment Build and Configuration
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../02-running-inspector/" class="md-nav__link">
        Module 2: Running Inspector
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../03-evaluate-findings/" class="md-nav__link">
        Module 3: Evaluating Findings
      </a>
    </li>
  

    
      
      
      

  
  
    
  
  
    <li class="md-nav__item md-nav__item--active">
      
      <input class="md-nav__toggle md-toggle" type="checkbox" id="__toc">
      
      
        
      
      
      <a href="./" class="md-nav__link md-nav__link--active">
        Module 4: Integration and Remediation
      </a>
      
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../05-cleanup/" class="md-nav__link">
        Module 5: Cleanup
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../contribute/" class="md-nav__link">
        Contributing
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../license/" class="md-nav__link">
        License
      </a>
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              
              <div class="md-sidebar md-sidebar--secondary" data-md-component="sidebar" data-md-type="toc" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
</nav>
                  </div>
                </div>
              </div>
            
          
          
            <div class="md-content" data-md-component="content">
              <article class="md-content__inner md-typeset">
                
                  


<h1 id="module-4-integration-and-remediation">Module 4 - Integration and Remediation</h1>
<p>In the previous module you identified issues with the network configuration and began remediating them. In this module you will leverage additional AWS services to deploy automatic remediations to known bad configurations. </p>
<h1 id="integrating-inspector-with-other-aws-security-services">Integrating Inspector with other AWS Security Services</h1>
<p>In the previous module you configured your assessment to send findings to a Simple Notification Service topic. Now you are going to use that to trigger a Lambda function to remediate common findings. The CloudFormation template has deployed a Lambda function to block SSH access to misconfigured instances and included it in the CloudFormation template. Let's build the connection from SNS to Lambda and review the code.</p>
<ol>
<li>
<p>Go to the Amazon Simple Notification Service console</p>
</li>
<li>
<p>Click on Topics on the left hand side</p>
<p><img alt="" src="../images/mod4-1-sns-topics.png" /></p>
</li>
<li>
<p>Click on the Topic named "InspectorAutomation"</p>
<p>In order to have the SNS topic send data to Lambda, you need to create a subscription. You should see the subscriptions window on the bottom and it should be empty.</p>
</li>
<li>
<p>Click Create Subscription</p>
<p><img alt="" src="../images/mod4-2-subscription.png" /></p>
</li>
<li>
<p>The Topic ARN should be filled out, but if it's not click on it and select the topic.</p>
</li>
<li>
<p>Click on the Protocol drop down and select AWS Lambda</p>
</li>
<li>
<p>You should now see another dropdown. Click on it and select the one Lambda function that's there.</p>
<p><img alt="" src="../images/mod4-3-create-subscription.png" /></p>
</li>
<li>
<p>Click Create Subscription</p>
<p>We've now configured SNS to send any alerts it receives to our Lambda function. Our Lambda function is configured to only respond to specific findings in specific ways. If you're interested in reviewing the Lambda function you can go to the Lambda console. The relevant piece of code for this activity are shown below:</p>
<p><img alt="" src="../images/mod4-13-lambda-code.png" /></p>
<p>You can see here that the Lambda code adds a Network ACL line that blocks SSH from the internet to any instance that has SSH open to the internet.</p>
<p>To trigger this you need to have Inspector submit a finding to SNS. Rather than wait 15 minutes for Inspector to finish an assessment though, you can simulate this action.</p>
</li>
<li>
<p>While still in SNS click on Topics on the left hand side</p>
</li>
<li>
<p>Click on the Topic named "InspectorAutomation"</p>
</li>
<li>
<p>In the top right click on the button that says "Publish Message"</p>
<p><img alt="" src="../images/mod4-4-publish.png" /></p>
<p>Using the ARN you copied down in Step 3 of Module 3 you are going to publish a fake SNS message using the appropriate ARN to kick off the Lambda function.</p>
<div class="admonition info">
<p class="admonition-title">What ARN?</p>
<p>If you don't have the ARN, you can go back to Inspector and copy the ARN from the Medium finding.</p>
</div>
</li>
<li>
<p>Paste the ARN into the appropriate place in the following text: {replace the "<strong>INSERT ARN HERE</strong>" with your arn)</p>
<p><code>{"template":"arn:aws:inspector:us-east-1:123456789012:target/0-a12b3c4d/template/0-5e6f7g8h","run":"arn:aws:inspector:us-east-1:123456789012:target/0-a12b3c4d/template/0-5e6f7g8h/run/0-9i0j1k2l","time":"2019-04-09T00:00:01.401Z","finding":"INSERT ARN HERE","event":"FINDING_REPORTED","target":"arn:aws:inspector:us-east-1:123456789012:target/0-a12b3c4d"}</code></p>
</li>
<li>
<p>Paste the SNS message from above in the "Message body to send to the endpoint" text box</p>
</li>
<li>
<p>Leave all the other fields empty</p>
<p><img alt="" src="../images/mod4-5-message.png" /></p>
</li>
<li>
<p>Click "Publish Message"</p>
<div class="admonition info">
<p class="admonition-title">If you're bored</p>
<p><p style="font-size:16px;">
Alternatively if you have the time, you can re-run the Inspector report and watch once it's complete to see if the change was made.
</p></p>
</div>
<p>To confirm that it worked you will check the Network ACL's.</p>
</li>
<li>
<p>Click on Services on the top right and click on VPC</p>
</li>
<li>
<p>On the left hand navigation click on Network ACLs</p>
<p><img alt="" src="../images/mod4-6-vpc-nacls.png" /></p>
</li>
<li>
<p>Since the Proof of Concept VPC is the one with the misconfiguration, click on the ACL associated with that VPC</p>
<p><img alt="" src="../images/mod4-7-nacls.png" /></p>
</li>
<li>
<p>On the bottom navigation, click on "Inbound Rules"</p>
<p><img alt="" src="../images/mod4-8-nacl-rules.png" /></p>
<p>Do you see a rule blocking SSH?</p>
<p>But if SSH is completely blocked to the instance, how can legitimate administrators configure the machine? Well, they can modify the Security Group and then the NACL through their Change Process. But if they want to make sure the instance wasn't compromised there's another option.</p>
</li>
<li>
<p>Click on Services on the top right and click on Systems Manager</p>
</li>
<li>
<p>On the left hand navigation, click on Session Manager</p>
<p><img alt="" src="../images/mod4-9-systems-manager.png" /></p>
</li>
<li>
<p>On the right hand side click on Start Session</p>
<p><img alt="" src="../images/mod4-10-session-manager.png" /></p>
<p>Do you remember the instance ID with the misconfigured Security Group? If not, don't worry, it was the PoC Web Server for AZ2</p>
</li>
<li>
<p>Click on the radio button next to the instance</p>
</li>
<li>
<p>Click Start Session</p>
<p><img alt="" src="../images/mod4-11-session-instances.png" /></p>
</li>
<li>
<p>Type "ping 8.8.8.8" - Are you able to ping out to the world? Hit Cntl-C when you're ready to move on.</p>
</li>
<li>
<p>Type "whoami" - What user are you logged into the box as?</p>
<p><img alt="" src="../images/mod4-12-active-session.png" /></p>
<p>This looks just like an SSH session! Instead though, this is a proxy created by the AWS System Manager Agent installed on the AMI. With the AWS Systems Manager Session Manager feature you can create an SSH-like access to devices that don't have port 22 open at all. All that's necessary is to allow traffic to the Systems Manager Endpoint over port 443 and return traffic.</p>
</li>
<li>
<p>When you're done, hit "Terminate" in the top right corner</p>
</li>
<li>
<p>Confirm you want to terminate the session.</p>
</li>
</ol>
<p>So now we've learned how you can use Inspector to kick off a Lambda function and automatically remediate potentially risks configurations. Additionally, you've seen how when you isolate instances from the world, you can still use AWS services to securely access them and perform troubleshooting or incidence response.</p>
<div class="admonition attention">
<p class="admonition-title">Attention</p>
<p><p style="font-size:16px;">
Now since there are some instances still open to the internet and potentially vulnerable, let's clean up what's been built.
</p></p>
</div>
<p><a href="../05-cleanup/">Cleanup</a></p>





                
              </article>
            </div>
          
          
        </div>
        
      </main>
      
        <footer class="md-footer">
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-copyright">
  
    <div class="md-copyright__highlight">
      <a href="https://aws.amazon.com/privacy/" target="_blank">Privacy</a> | <a href="https://aws.amazon.com/terms/" target="_blank">Site terms</a> | &copy; 2023, Amazon Web Services, Inc. or its affiliates. All rights reserved.
    </div>
  
  
    Made with
    <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
      Material for MkDocs
    </a>
  
</div>
      
    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    
    <script id="__config" type="application/json">{"base": "..", "features": [], "search": "../assets/javascripts/workers/search.208ed371.min.js", "translations": {"clipboard.copied": "Copied to clipboard", "clipboard.copy": "Copy to clipboard", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.placeholder": "Type to start searching", "search.result.term.missing": "Missing", "select.version": "Select version"}}</script>
    
    
      <script src="../assets/javascripts/bundle.fc8c2696.min.js"></script>
      
    
  </body>
</html>